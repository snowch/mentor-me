# Build Scripts

This directory contains scripts for building and testing the MentorMe Flutter application.

## local-ci-build.sh

Replicates the GitHub Actions CI/CD pipeline locally, allowing you to test your changes before committing.

### What it does

The script performs the same steps as the CI/CD pipeline:

1. âœ… Generates `lib/config/build_info.dart` (git commit + timestamp)
2. âœ… Verifies Flutter installation
3. âœ… Gets Flutter dependencies
4. âœ… Runs `flutter analyze`
5. âœ… Runs `flutter test --coverage`
6. âœ… Runs schema validation tests (CRITICAL - fails build if fails)
7. âœ… Runs provider tests (CRITICAL - fails build if fails)
8. âœ… Builds debug APK
9. âœ… Builds release APK

### Usage

```bash
# Full CI/CD build (includes APK building - takes ~5-10 minutes)
./scripts/local-ci-build.sh

# Quick validation (skip APK build - takes ~1-2 minutes)
./scripts/local-ci-build.sh --skip-build

# Test analysis only (skip tests and build - takes ~30 seconds)
./scripts/local-ci-build.sh --skip-tests --skip-build

# Clean build from scratch
./scripts/local-ci-build.sh --clean

# Show help
./scripts/local-ci-build.sh --help
```

### Options

| Option | Description |
|--------|-------------|
| `--skip-build` | Skip APK building (faster for quick testing) |
| `--skip-tests` | Skip running tests |
| `--clean` | Run `flutter clean` first |
| `--help`, `-h` | Show help message |

### When to use

**Before committing:**
```bash
# Quick check (recommended before every commit)
./scripts/local-ci-build.sh --skip-build

# Full check (recommended before PR)
./scripts/local-ci-build.sh
```

**During development:**
```bash
# Test analysis and critical tests only
./scripts/local-ci-build.sh --skip-build
```

**After major changes:**
```bash
# Full clean build
./scripts/local-ci-build.sh --clean
```

### What gets tested

#### âœ… Always runs (unless skipped)
- Flutter analyzer
- All unit tests with coverage
- Schema validation tests
- Provider tests

#### ğŸ”´ Critical tests (fail build if fail)
- **Schema validation** - Ensures Dart models match JSON schemas
- **Provider tests** - Prevents state management regressions

#### âš ï¸ Non-blocking (warnings only)
- Flutter analyzer issues
- Test failures in non-critical tests
- Low code coverage

### Output

The script provides color-coded output:
- ğŸ”µ **Blue** - Information
- ğŸŸ¡ **Yellow** - Warnings or in-progress
- ğŸŸ¢ **Green** - Success
- ğŸ”´ **Red** - Failure

Example output:
```
========================================
  Local CI/CD Build Test
========================================

[1/9] Generating build_info.dart...
âœ“ Generated build_info.dart
  Commit: 16440b1
  Timestamp: 2025-11-22T19:30:00Z

[2/9] Verifying Flutter installation...
âœ“ Flutter verified

...

========================================
  âœ“ Local CI/CD build complete!
========================================

Your changes are ready to commit and should pass CI/CD.
```

### Generated files

The script generates `lib/config/build_info.dart` which contains:
- Git commit hash (full and short)
- Build timestamp

**This file is in `.gitignore` and should NOT be committed.**

It's automatically generated by CI/CD during actual builds.

### Cleanup

After running the script, you can:

**Keep build_info.dart** (to run the app locally with build info):
```bash
# Leave it - allows Debug Settings screen to work
```

**Remove build_info.dart** (if you want clean analyzer output):
```bash
rm lib/config/build_info.dart
# Or run: git clean -f lib/config/
```

### Troubleshooting

**"Permission denied" error:**
```bash
chmod +x scripts/local-ci-build.sh
```

**"lcov: command not found":**
```bash
# Coverage percentage won't be calculated, but tests still run
# To install lcov:
sudo apt-get install lcov  # Ubuntu/Debian
brew install lcov           # macOS
```

**Script exits early:**
- Check which step failed (red âœ—)
- Critical tests (schema validation, provider tests) will fail the build
- Fix the issues before committing

### CI/CD comparison

| Feature | Local Script | GitHub Actions |
|---------|--------------|----------------|
| Build info generation | âœ… Yes | âœ… Yes |
| Flutter analyze | âœ… Yes | âœ… Yes |
| Run tests | âœ… Yes | âœ… Yes |
| Schema validation | âœ… Yes (critical) | âœ… Yes (critical) |
| Provider tests | âœ… Yes (critical) | âœ… Yes (critical) |
| Build APK | âœ… Yes | âœ… Yes |
| Upload artifacts | âŒ No (local only) | âœ… Yes |
| Coverage upload | âŒ No | âœ… Yes (Codecov) |

### Example workflows

**Quick pre-commit check:**
```bash
# 1. Make your changes
vim lib/some_file.dart

# 2. Run quick validation
./scripts/local-ci-build.sh --skip-build

# 3. If passes, commit
git add .
git commit -m "Your changes"
git push
```

**Full pre-PR check:**
```bash
# 1. Run full build including APKs
./scripts/local-ci-build.sh

# 2. If passes, create PR
gh pr create --title "Your PR title"
```

**Debug failing CI/CD:**
```bash
# 1. Run locally to reproduce
./scripts/local-ci-build.sh

# 2. Fix issues
# 3. Re-run until passes
./scripts/local-ci-build.sh --skip-build

# 4. Push fix
git push
```

---

## Pre-commit Hook

The repository includes a **pre-commit hook** that automatically runs local CI/CD validation before every commit.

### What it does

When you run `git commit`, the hook will:
1. Automatically run `./scripts/local-ci-build.sh --skip-build`
2. Check Flutter analyzer, run tests, and validate schemas
3. **Allow commit** if all checks pass âœ…
4. **Abort commit** if checks fail âŒ

### Benefits

- **Prevents build failures** - Catches issues before they reach CI/CD
- **Saves time** - No waiting for CI/CD to fail on GitHub
- **Enforces quality** - All commits are pre-validated

### Installation

The pre-commit hook is located at `.git/hooks/pre-commit` and should be automatically set up.

To verify it's installed:
```bash
ls -la .git/hooks/pre-commit
# Should show: -rwxr-xr-x (executable)
```

To manually install/reinstall:
```bash
cp .git/hooks/pre-commit.sample .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

### Bypassing (NOT recommended)

If you absolutely need to commit without validation:
```bash
git commit --no-verify -m "Emergency fix"
```

**âš ï¸ Warning:** This may cause CI/CD failures. Only use in emergencies.

### Example output

```
ğŸ” Running pre-commit validation...

[1/9] Generating build_info.dart...
âœ“ Generated build_info.dart

[2/9] Verifying Flutter installation...
âœ“ Flutter verified

[3/9] Getting Flutter dependencies...
âœ“ Dependencies installed

[4/9] Running Flutter analyzer...
âœ“ Analyzer passed

[5/9] Running all tests with coverage...
âœ“ All tests passed (37 tests)

[6/9] Running schema validation test...
âœ“ Schema validation passed

[7/9] Running provider tests...
âœ“ Provider tests passed

âœ… Pre-commit validation PASSED!
Proceeding with commit...

[main 1234567] Your commit message
 2 files changed, 50 insertions(+)
```

### Workflow with pre-commit hook

```bash
# 1. Make your changes
vim lib/screens/chat_screen.dart

# 2. Stage your changes
git add lib/screens/chat_screen.dart

# 3. Commit (hook runs automatically)
git commit -m "Add save to journal feature"
# â†’ Hook runs local CI/CD validation
# â†’ If passes: commit succeeds
# â†’ If fails: commit aborted, fix issues first

# 4. Push
git push
```

---

## Future scripts

Other scripts that could be added here:
- `format-code.sh` - Auto-format all Dart code
- `run-web.sh` - Start proxy and Flutter web in parallel
- `update-deps.sh` - Update and test dependency upgrades
- `generate-icons.sh` - Generate app icons from source
