# Build Scripts

This directory contains scripts for building and testing the MentorMe Flutter application.

## local-ci-build.sh

Replicates the GitHub Actions CI/CD pipeline locally, allowing you to test your changes before committing.

### What it does

The script performs the same steps as the CI/CD pipeline:

1. âœ… Generates `lib/config/build_info.dart` (git commit + timestamp)
2. âœ… Verifies Flutter installation
3. âœ… Gets Flutter dependencies
4. âœ… Runs `flutter analyze --no-fatal-infos --no-fatal-warnings lib/` (production code only)
5. âœ… Runs `flutter test --coverage`
6. âœ… Runs schema validation tests (CRITICAL - fails build if fails)
7. âœ… Runs provider tests (CRITICAL - fails build if fails)
8. âœ… Builds debug APK
9. âœ… Builds release APK

### Usage

```bash
# Full CI/CD build (includes APK building - takes ~5-10 minutes)
./scripts/local-ci-build.sh

# Quick validation (skip APK build - takes ~1-2 minutes)
./scripts/local-ci-build.sh --skip-build

# Test analysis only (skip tests and build - takes ~30 seconds)
./scripts/local-ci-build.sh --skip-tests --skip-build

# Clean build from scratch
./scripts/local-ci-build.sh --clean

# Show help
./scripts/local-ci-build.sh --help
```

### Options

| Option | Description |
|--------|-------------|
| `--skip-build` | Skip APK building (faster for quick testing) |
| `--skip-tests` | Skip running tests |
| `--clean` | Run `flutter clean` first |
| `--help`, `-h` | Show help message |

### When to use

**Before committing:**
```bash
# Quick check (recommended before every commit)
./scripts/local-ci-build.sh --skip-build

# Full check (recommended before PR)
./scripts/local-ci-build.sh
```

**During development:**
```bash
# Test analysis and critical tests only
./scripts/local-ci-build.sh --skip-build
```

**After major changes:**
```bash
# Full clean build
./scripts/local-ci-build.sh --clean
```

### What gets tested

#### âœ… Always runs (unless skipped)
- Flutter analyzer (production code in `lib/` only)
- All unit tests with coverage
- Schema validation tests
- Provider tests

#### ğŸ”´ Critical tests (fail build if fail)
- **Flutter analyzer compilation errors** - Fails on errors in `lib/` directory
- **Schema validation** - Ensures Dart models match JSON schemas
- **Provider tests** - Prevents state management regressions

#### âš ï¸ Non-blocking (warnings only)
- Flutter analyzer warnings and info messages (only errors are fatal)
- Test failures in non-critical tests
- Low code coverage
- Test file errors (analyzer only checks `lib/`, not `test/`)

### Output

The script provides color-coded output:
- ğŸ”µ **Blue** - Information
- ğŸŸ¡ **Yellow** - Warnings or in-progress
- ğŸŸ¢ **Green** - Success
- ğŸ”´ **Red** - Failure

Example output:
```
========================================
  Local CI/CD Build Test
========================================

[1/9] Generating build_info.dart...
âœ“ Generated build_info.dart
  Commit: 16440b1
  Timestamp: 2025-11-22T19:30:00Z

[2/9] Verifying Flutter installation...
âœ“ Flutter verified

...

========================================
  âœ“ Local CI/CD build complete!
========================================

Your changes are ready to commit and should pass CI/CD.
```

### Generated files

The script generates `lib/config/build_info.dart` which contains:
- Git commit hash (full and short)
- Build timestamp

**This file is in `.gitignore` and should NOT be committed.**

It's automatically generated by CI/CD during actual builds.

### Cleanup

After running the script, you can:

**Keep build_info.dart** (to run the app locally with build info):
```bash
# Leave it - allows Debug Settings screen to work
```

**Remove build_info.dart** (if you want clean analyzer output):
```bash
rm lib/config/build_info.dart
# Or run: git clean -f lib/config/
```

### Troubleshooting

**"Permission denied" error:**
```bash
chmod +x scripts/local-ci-build.sh
```

**"lcov: command not found":**
```bash
# Coverage percentage won't be calculated, but tests still run
# To install lcov:
sudo apt-get install lcov  # Ubuntu/Debian
brew install lcov           # macOS
```

**Script exits early:**
- Check which step failed (red âœ—)
- Critical tests (schema validation, provider tests) will fail the build
- Fix the issues before committing

### CI/CD comparison

| Feature | Local Script | GitHub Actions |
|---------|--------------|----------------|
| Build info generation | âœ… Yes | âœ… Yes |
| Flutter analyze | âœ… Yes (`lib/` only) | âœ… Yes (`lib/` only) |
| Run tests | âœ… Yes | âœ… Yes |
| Schema validation | âœ… Yes (critical) | âœ… Yes (critical) |
| Provider tests | âœ… Yes (critical) | âœ… Yes (critical) |
| Build APK | âœ… Yes | âœ… Yes |
| Upload artifacts | âŒ No (local only) | âœ… Yes |
| Coverage upload | âŒ No | âœ… Yes (Codecov) |

**Note:** The analyzer only checks production code (`lib/` directory) to focus on code that runs in production. Test files have their own validation via `flutter test`.

### Example workflows

**Quick pre-commit check:**
```bash
# 1. Make your changes
vim lib/some_file.dart

# 2. Run quick validation
./scripts/local-ci-build.sh --skip-build

# 3. If passes, commit
git add .
git commit -m "Your changes"
git push
```

**Full pre-PR check:**
```bash
# 1. Run full build including APKs
./scripts/local-ci-build.sh

# 2. If passes, create PR
gh pr create --title "Your PR title"
```

**Debug failing CI/CD:**
```bash
# 1. Run locally to reproduce
./scripts/local-ci-build.sh

# 2. Fix issues
# 3. Re-run until passes
./scripts/local-ci-build.sh --skip-build

# 4. Push fix
git push
```

---

## Pre-commit Hook

The repository includes a **pre-commit hook** that automatically runs local CI/CD validation before every commit.

**ğŸ“– Full documentation:** See [`.githooks/README.md`](../.githooks/README.md)

### Quick Install

```bash
./.githooks/install.sh
```

This installs a git hook that:
- Runs `./scripts/local-ci-build.sh --skip-build` before every commit
- Validates code with analyzer, tests, and schemas
- **Prevents CI/CD failures** by catching issues locally

### Why Use It?

| Without Hook âŒ | With Hook âœ… |
|----------------|-------------|
| Commit â†’ Push â†’ Wait 5-10 min â†’ **CI/CD fails** â†’ Fix â†’ Repeat | Commit â†’ **Hook validates (1-2 min)** â†’ Fix if needed â†’ Push â†’ **CI/CD passes** |

**Benefits:**
- ğŸš€ **Faster feedback** - 1-2 minutes vs 5-10 minutes
- ğŸ›¡ï¸ **Prevent failures** - Catch issues before push
- ğŸ’° **Save time** - No failed builds to debug
- âœ… **Quality assurance** - All commits pre-validated

### After Installation

The hook runs automatically on every commit:

```bash
# Make changes
vim lib/screens/chat_screen.dart

# Stage and commit
git add lib/screens/chat_screen.dart
git commit -m "Add new feature"
# â†’ Hook runs automatically
# â†’ If passes: commit succeeds âœ…
# â†’ If fails: commit aborted âŒ

# Push with confidence
git push
```

See [`.githooks/README.md`](../.githooks/README.md) for full details, troubleshooting, and advanced usage.

---

## Fail-Fast Error Detection

The CI/CD pipeline uses a **fail-fast** approach to catch errors as quickly as possible:

### Error Detection Hierarchy

| Layer | Tool | When | Speed | What It Catches |
|-------|------|------|-------|-----------------|
| **1. Pre-commit hook** | `flutter analyze` | Before commit | ~10-30s | Compilation errors (auto-installed) |
| **2. Local CI script** | `./scripts/local-ci-build.sh` | Before push | ~1-2min | Errors + test failures |
| **3. GitHub Actions** | CI/CD pipeline | After push | ~30s-6min | Same as local CI |

### Performance Improvements

**Before fail-fast optimization:**
- Compilation errors caught during APK build step (~6-14 minutes into build)
- Total time to feedback: **6-14 minutes**

**After fail-fast optimization:**
- Compilation errors caught during analyzer step (~30 seconds into build)
- Total time to feedback: **30-53 seconds**
- **10-17x faster feedback!** âš¡

### How It Works

1. **Analyzer step runs first** with `--no-fatal-infos --no-fatal-warnings`
   - Only treats compilation errors as fatal
   - Warnings and info messages are non-blocking
   - Checks only `lib/` directory (production code)

2. **If analyzer finds errors** â†’ Build fails immediately (30s)
3. **If analyzer passes** â†’ Continue with tests and builds

4. **Tests run after analyzer**
   - Schema validation (fails build if fails)
   - Provider tests (fails build if fails)
   - Other tests (non-blocking)

5. **APK builds run last** (only if all critical checks pass)

### Why Analyze Only `lib/`?

The analyzer focuses on production code (`lib/` directory) because:
- Test files have their own validation via `flutter test`
- Broken test files shouldn't block production builds
- Faster feedback (fewer files to analyze)
- Clearer separation of concerns

Pre-existing broken test files (e.g., gherkin integration tests) won't block CI/CD, but they can be fixed separately as technical debt.

---

## Future scripts

Other scripts that could be added here:
- `format-code.sh` - Auto-format all Dart code
- `run-web.sh` - Start proxy and Flutter web in parallel
- `update-deps.sh` - Update and test dependency upgrades
- `generate-icons.sh` - Generate app icons from source
